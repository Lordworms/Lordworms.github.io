
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>database redis | Waiting for the dawn</title>
        <meta name="author" content="Yanxin Xiang">
        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <link rel="icon" href="https://i.ibb.co/1T1D1D9/QQ20230529-1.jpg">
        <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script>
        <script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
        <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css">
        <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css">
        
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        
        
        <script src="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.js"></script>
        <script src="https://cdn.staticfile.org/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.css">
        
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
    <meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <div id="loading" style="height: 100vh; width: 100vw; left: 0; top: 0; position: fixed; display: flex; z-index: 2147483647; background: #fff; transition: opacity 0.3s ease-out; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; pointer-events: none">
    <div style="width: 50vmin; height: 50vmin; margin: auto; padding: 50px; border-radius: 50%; display: flex; border: solid 10px #a3ddfb">
        <div style="margin: auto; text-align: center">
            <h2>LOADING</h2>
            <p>加载过慢请开启缓存，浏览器默认开启</p>
            <img src="/images/loading.gif" style="height: 50px; border-radius: 0">
        </div>
    </div>
</div>

        <div id="layout">
            <transition name="into">
            <div id="main" v-show="showpage" style="display: -not-none">
                <nav id="menu">
    <div class="desktop-menu">
        <a class="title" href="/">
            <span>WAITING FOR THE DAWN</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div :class="&quot;phone-menu &quot; + menushow" id="phone-menu">
        <div class="curtain" @click="menushow = !menushow" v-show="menushow"></div>
        <div class="title" @click="menushow = !menushow">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;WAITING FOR THE DAWN</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menushow">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>database redis </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/3/21
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/tags/database/" style="color: #ffa2c4">database</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/redis/" style="color: #00a596">redis</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <p>1.特点<br>a.kv存储，底层使用unordered_map，可以达到O(1)存储。</p>
<p>b.封装了epoll，高效的网络io模型</p>
<p>c.高效的线程模型</p>
<p>d.接收客户端请求-&gt;解析请求 -&gt;进行数据读写等操作-&gt;发生数据给客户端是单线程的</p>
<p>2.封装一个键值对的数据结构叫做一个entry。</p>
<p>所有的键先对key完成一次hash，然后对hash table的长度进行求模，然后存放对应的指针</p>
<p>使用链表法来解决冲突，使用头插法</p>
<p>3.redis的扩容，当链表过长需要扩容，然后重哈希（渐进式重哈希）</p>
<p>不需要一次性搬完，后台一点一点搬，等到老数据全都到新的，然后再释放老的，新元素要插入需要插入到新的hash table中</p>
<p>4.key的类型</p>
<p>key的长度可以很大</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类别</th>
<th>可以的类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>Stringlist,zset,hash,stree</td>
</tr>
<tr>
<td>key</td>
<td>可以是任意数据类型，文件、音频，最终服务器会变成string</td>
</tr>
</tbody>
</table>
</div>
<p>5.Redis类型的设计</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>1.定义一个len(长度),一个free(多的空间)还有一个char[],有一个flag，前3位表示类型，后面5位表示长度(hdr5)<br>2.扩容的时候成倍地去扩容<br>3.</td>
</tr>
</tbody>
</table>
</div>
<p>值最终都会放在redis object中</p>
<p>6.底层的实现</p>
<h1 id="面经部分"><a href="#面经部分" class="headerlink" title="面经部分"></a>面经部分</h1><h2 id="Redis到底是单线程还是多线程？"><a href="#Redis到底是单线程还是多线程？" class="headerlink" title="Redis到底是单线程还是多线程？"></a>Redis到底是单线程还是多线程？</h2><p>6.0版本前网络I/O和键值对的读写都由一个线程完成。6.0后核心命令还是单线程，但是网络I/O使用了多CPU的多线程，所以还是并发安全的。（持久化、数据同步等都还是多线程）</p>
<h2 id="1-Redis单线程为什么还能这么快"><a href="#1-Redis单线程为什么还能这么快" class="headerlink" title="1.Redis单线程为什么还能这么快"></a>1.Redis单线程为什么还能这么快</h2><p>1.命令基于内存操作</p>
<p>2.命令执行是单线程操作，没有线程切换的开销</p>
<p>3.基于IO多路复用机制提升Redis的I/O效率（基于epoll）</p>
<p>4.高效的数据存储结构：全局hash表、跳表、压缩列表、链表</p>
<p>3.Redis底层数据如何用跳表存储</p>
<p>对于zset来说，可以用跳表实现</p>
<p>跳表怎么做的：</p>
<p>1.把链表每2个元素做一个冗余元素，继续向上，做成索引.</p>
<p>2.对于查找来说，我们从最高的索引来查找，复杂度差不多为O(logn),类似二分的思想</p>
<h2 id="2-Redis-key过期了为什么内存没释放"><a href="#2-Redis-key过期了为什么内存没释放" class="headerlink" title="2.Redis key过期了为什么内存没释放"></a>2.Redis key过期了为什么内存没释放</h2><p>1.修改值的时候要带上过期时间，不然永远不过期</p>
<p>2.Redis对过期key的策略，有惰性删除和定时删除，所以可能出现过期了还没被删除的情况（默认定期删除）</p>
<h2 id="3-Redi-key没设置过期时间为什么被主动删除了"><a href="#3-Redi-key没设置过期时间为什么被主动删除了" class="headerlink" title="3.Redi key没设置过期时间为什么被主动删除了"></a>3.Redi key没设置过期时间为什么被主动删除了</h2><p>Redis内存淘汰策略：</p>
<p>当Redis超过内存最大限制的时候，会触发主动清理策略(lru\lfu删除)</p>
<h2 id="4-Redis淘汰算法-LRU和LFU的区别"><a href="#4-Redis淘汰算法-LRU和LFU的区别" class="headerlink" title="4.Redis淘汰算法 LRU和LFU的区别"></a>4.Redis淘汰算法 LRU和LFU的区别</h2><p>最近最少使用和最近被访问次数最少的，当存在大量的热点缓存数据的时候，可能LFU比较好</p>
<h2 id="5-删除key的命令会阻塞Redis吗"><a href="#5-删除key的命令会阻塞Redis吗" class="headerlink" title="5.删除key的命令会阻塞Redis吗"></a>5.删除key的命令会阻塞Redis吗</h2><pre><code class="lang-Redis">DEL key [k..]
</code></pre>
<p>删除给定的一个或多个key</p>
<p>删除耽搁列表、集合、有序函数或者哈希表的key，时间复杂度为O(M),M为以上数据结构内的元素数量</p>
<h2 id="6-Redis主从、哨兵、集群"><a href="#6-Redis主从、哨兵、集群" class="headerlink" title="6.Redis主从、哨兵、集群"></a>6.Redis主从、哨兵、集群</h2><div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>主从模式</td>
<td>1.数据从主节点备份到从节点，主节点挂了，从节点变为主节点</td>
<td></td>
</tr>
<tr>
<td>哨兵模式</td>
<td>1.增加一些哨兵节点（本质也是redis实例）<br>2.对每一个redis主从进行监听<br>3.如果主节点挂了，哨兵感知到，然后重新选举出一个新的节点<br>4.随后客户端可以访问新的主节点<br>5.可以自动化，但是主从切换比较慢</td>
<td>提供服务只有一个节点支持，无法满足大并发<br>Redis单节点不要超过10G，不然影响恢复</td>
</tr>
<tr>
<td>集群模式</td>
<td>1.多个小的主从节点统一成一个大的来对外处理<br>2.不会把所有数据放在一个节点，而是分片存储<br></td>
<td>不要超过1000个节点</td>
</tr>
</tbody>
</table>
</div>
<h2 id="7-Redis集群数据哈希分片算法"><a href="#7-Redis集群数据哈希分片算法" class="headerlink" title="7.Redis集群数据哈希分片算法"></a>7.Redis集群数据哈希分片算法</h2><p>集群客户端有一个哈希分片算法，逻辑上划分为16384个槽位，然后每个节点分别划分一片槽位</p>
<p>HASH_SLOT=CRC16(key) mod 16384</p>
<h2 id="8-Redi执行命令阻塞循环"><a href="#8-Redi执行命令阻塞循环" class="headerlink" title="8.Redi执行命令阻塞循环"></a>8.Redi执行命令阻塞循环</h2><p>Random KEY，如果有大量的key过期了，然后又有可能都拿到过期的</p>
<p>slave上执行random key，因为slave不会主动删除，需要master同步之后再会删除</p>
<h2 id="9-Redis主从切换导致缓存雪崩"><a href="#9-Redis主从切换导致缓存雪崩" class="headerlink" title="9.Redis主从切换导致缓存雪崩"></a>9.Redis主从切换导致缓存雪崩</h2><p>假设主节点的机器时钟比从节点走的很慢，这个时候发生主从切换之后，在主节点认为没过期的可能从节点过期了，切换之后，出问题。</p>
<h2 id="10-Redis持久化"><a href="#10-Redis持久化" class="headerlink" title="10.Redis持久化"></a>10.Redis持久化</h2><div class="table-container">
<table>
<thead>
<tr>
<th>方法名称</th>
<th>特点</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>RDB快照持久化</td>
<td>在指定的时间内，把内存中的数据库快照写入磁盘，实际的过程是fork一个子进程，先把数据写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储</td>
<td>1.整个数据库只包括一个文件dump.rdb，方便与持久化<br>2.容灾性好，方便备份<br>3.性能最大化，fork子进程来完成写操作，让主进程继续处理命令，所以是IO最大化，主进程不会进行任何IO操作</td>
<td>1.数据安全性低，RDB是间隔一段时间进行持久化，如果持久化期间redis发生故障，会发生数据丢失<br>2.由于RDB借助fork来完成持久化工作，所以如果数据集比较大，会导致整个服务停止1秒</td>
</tr>
<tr>
<td>AOF(append file)</td>
<td>以日志的形式，类似redolog</td>
<td>1.数据安全。2.通过append模式写文件，即使宕机也不会破坏已经存在的内容。3.定期对AOF进行重写，达到压缩的目的</td>
<td>1.AOF文件比RDB文件大2.比rdb启动效率低。3.运行效率没有RDB高</td>
</tr>
</tbody>
</table>
</div>
<h2 id="11-Redis主从复制风暴"><a href="#11-Redis主从复制风暴" class="headerlink" title="11.Redis主从复制风暴"></a>11.Redis主从复制风暴</h2><p>主节点可能要一次性连多个从节点来传输快照，导致压力比较大</p>
<h2 id="12-主从频繁切换"><a href="#12-主从频繁切换" class="headerlink" title="12.主从频繁切换"></a>12.主从频繁切换</h2><p>网络抖动导致频繁的主从切换，需要使用timeout来进行主从切换的判断</p>
<h2 id="13-Redis集群为什么至少需要3个master节点"><a href="#13-Redis集群为什么至少需要3个master节点" class="headerlink" title="13.Redis集群为什么至少需要3个master节点"></a>13.Redis集群为什么至少需要3个master节点</h2><p>3个以上才能选举成功</p>
<h2 id="14-Redis集群为什么需要奇数个节点"><a href="#14-Redis集群为什么需要奇数个节点" class="headerlink" title="14.Redis集群为什么需要奇数个节点"></a>14.Redis集群为什么需要奇数个节点</h2><p>新master的选举需要半数同意</p>
<h2 id="15-Redis批量操作命令"><a href="#15-Redis批量操作命令" class="headerlink" title="15.Redis批量操作命令"></a>15.Redis批量操作命令</h2><p>必须落在同一个节点，不然会报错</p>
<h2 id="16-缓存穿透，缓存击穿、缓存雪崩"><a href="#16-缓存穿透，缓存击穿、缓存雪崩" class="headerlink" title="16.缓存穿透，缓存击穿、缓存雪崩"></a>16.缓存穿透，缓存击穿、缓存雪崩</h2><p>对于一个请求来说，如果redis中存在，直接返回，否则去数据库中查，然后添加入redis</p>
<p>布隆过滤器：不在一定不在，在可能有问题（有碰撞），只能加数据不能减数据</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类别</th>
<th>特点</th>
<th>策略</th>
</tr>
</thead>
<tbody>
<tr>
<td>缓存穿透</td>
<td>1.缓存中查不到，数据库中也查不到。然后不断地拿这条sql来攻击</td>
<td>1.进行参数校验。<br>2.把数据库中没有查到结果的数据也写入缓存<br>3.引入布隆过滤器(可以判断是否在集合当中，通过哈希散列来做)，在访问redis前对query进行校验</td>
</tr>
<tr>
<td>缓存击穿</td>
<td>DB中有，缓存中没有，一般出现在缓存失效或者过期的情况,高并发场景下数据库压力瞬间增大</td>
<td>1.设置缓存热点数据永不过期,在逻辑上设置一个过期时间<br>2.加载db的时候需要防止并发，每次只有一个线程可以写</td>
</tr>
<tr>
<td>缓存雪崩</td>
<td>1.缓存大面积过期，导致请求都被转发到DB</td>
<td>1.把缓存的失效时间分散开<br>2.对热点数据设置永不过期</td>
</tr>
</tbody>
</table>
</div>
<h2 id="17-Redis的partition"><a href="#17-Redis的partition" class="headerlink" title="17. Redis的partition"></a>17. Redis的partition</h2><p>Redis 的分区（partition）是指将 Redis 数据库中的数据分散到多个物理节点或者服务器上，以提高数据库的性能、可扩展性和可用性。</p>
<p>Redis 支持多种分区模式，包括：</p>
<p>哈希分区：Redis 将键值对根据键名进行哈希，然后将哈希结果分散到多个物理节点或者服务器上。这种分区模式可以将键值对均匀分布到多个节点上，从而提高性能和可扩展性。但是，这种分区模式不能保证数据在所有节点上的复制，也不能保证数据在所有节点上的一致性。</p>
<p>范围分区：Redis 将数据按照键名的范围进行分区，每个节点或者服务器负责一定范围内的键值对。这种分区模式可以保证数据在所有节点上的复制和一致性，但是在键名分布不均匀时，可能会导致节点负载不均衡的问题。</p>
<p>副本分区：Redis 将数据进行复制，并将复制品存储在多个物理节点或者服务器上。这种分区模式可以保证数据的高可用性和容错性，但是可能会增加存储和网络带宽的开销。</p>
<p>Redis 分区可以在多个物理节点或者服务器上同时进行读写操作，从而提高数据库的并发性能和可用性。但是，在分区模式下，数据的管理和维护变得更加复杂，需要进行节点之间的数据同步、负载均衡、故障恢复等操作。因此，在设计和实现 Redis 分区时，需要考虑到数据库的特性、数据的分布和访问模式、节点的规模和配置等因素。</p>

    </div>
    
    
    
    
    
    <div id="comment">
        <div id="waline-container"></div>
    </div>
    
    
    
</div>

                <footer id="footer">
    <div class="footer-wrap">
        <div>
            &copy;
            2022 - 2023 Waiting for the dawn
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Yanxin Xiang
        </div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>

            </div>
            </transition>
            <div id="showimg">
                <img id="showimg-content">
            </div>
        </div>
        <script src="/js/functions.js"></script>
<script src="/js/particlex.js"></script>




<script src="https://cdn.staticfile.org/waline/2.14.7/waline.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.14.7/waline.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.14.7/waline-meta.min.css">
<script>
    Waline.init({
        el: "#waline-container",
        serverURL: "https://blog-comment-one-pi.vercel.app",
        commentCount: true,
        pageview: false,
        emoji: ["https://unpkg.com/@waline/emojis@1.2.0/weibo","https://unpkg.com/@waline/emojis@1.2.0/alus","https://unpkg.com/@waline/emojis@1.2.0/bilibili","https://unpkg.com/@waline/emojis@1.2.0/qq","https://unpkg.com/@waline/emojis@1.2.0/tieba","https://unpkg.com/@waline/emojis@1.2.0/tw-emoji"],
        meta: ["nick","mail","link"],
        requiredMeta: ["nick"],
        lang: "zh-CN",
        wordLimit: 0,
        pageSize: "10",
        login: "enable",
        locale: {},
    });
</script>




    </body>
</html>
